#eval compdef -n _parse_opts want
# ZSH function file
# Halt a shell, waiting for a trigger (supplied by 'go')
#
# $Id: want,v 1.2 2001/08/03 12:49:32 mebourne Exp $

local -A opts
parse_opts - opts -- "$argv[@]" <<'EOF' || return 1
Description:
Halt a shell, waiting for a trigger (supplied by 'go')

Usage:
want [options] <semaphore>

Options:
  -h, --help			Provide this help
				# --help | -h

Arguments:
  <semaphore>			Name of semaphore to wait for
				# semaphore : text
EOF

if [[ -z semaphore_base ]]
then
  echo "ERROR: semaphore_base not defined" 1>&2
  return 1
fi

local file="$semaphore_base$opts[semaphore]"

print -P "Waiting on semaphore '$opts[semaphore]' at %D{%a %f %b %Y %H:%M:%S}"

# 'go' will write the file we are watching for
while [[ ! -e $file ]]
do
  sleep 5
done

# Tidy up
rm -f $file

print -P "Received semaphore '$opts[semaphore]' at %D{%a %f %b %Y %H:%M:%S}"
